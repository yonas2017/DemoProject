\chapter{Test Flatbuffers library with help of lib\+Fuzzer}
\hypertarget{md_flatbuffers_2tests_2fuzzer_2readme}{}\label{md_flatbuffers_2tests_2fuzzer_2readme}\index{Test Flatbuffers library with help of libFuzzer@{Test Flatbuffers library with help of libFuzzer}}
Test suite of Flatbuffers library has fuzzer section with tests are based on lib\+Fuzzer library.

\begin{quote}
Lib\+Fuzzer is in-\/process, coverage-\/guided, evolutionary fuzzing engine. \end{quote}
Lib\+Fuzzer is linked with the library under test, and feeds fuzzed inputs to the library via a specific fuzzing entrypoint (aka “target function”); the fuzzer then tracks which areas of the code are reached, and generates mutations on the corpus of input data in order to maximize the code coverage. The code coverage information for lib\+Fuzzer is provided by LLVM’s Sanitizer\+Coverage instrumentation.

For details about {\bfseries{lib\+Fuzzer}} see\+: \href{https://llvm.org/docs/LibFuzzer.html}{\texttt{ https\+://llvm.\+org/docs/\+Lib\+Fuzzer.\+html}}

To build and run these tests LLVM compiler (with clang frontend) and CMake should be installed before.

The fuzzer section include four tests\+:
\begin{DoxyItemize}
\item {\ttfamily annotator\+\_\+fuzzer} checks that inputs given to the flatc --annotate are always parsable;
\item {\ttfamily verifier\+\_\+fuzzer} checks stability of deserialization engine for {\ttfamily Monster} schema;
\item {\ttfamily parser\+\_\+fuzzer} checks stability of schema and json parser under various inputs;
\item {\ttfamily scalar\+\_\+parser} focused on validation of the parser while parse numeric scalars in schema and/or json files;
\item {\ttfamily flexverifier\+\_\+fuzzer} checks stability of deserialization engine for Flex\+Buffers only;
\end{DoxyItemize}

\doxysection*{Build}


\begin{DoxyCode}{0}
\DoxyCodeLine{cd\ tests/fuzzer}
\DoxyCodeLine{CC=clang\ CXX=clang++\ cmake\ .\ -\/DCMAKE\_BUILD\_TYPE=Debug\ -\/DUSE\_ASAN=ON}

\end{DoxyCode}


\doxysection*{Run tests with a specific locale}

The grammar of the Flatbuffers library is based on printable-\/\+ASCII characters. By design, the Flatbuffers library should be independent of the global or thread locales used by an end-\/user application. Set environment variable {\ttfamily FLATBUFFERS\+\_\+\+TEST\+\_\+\+LOCALE} to run a fuzzer with a specific C-\/locale\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{>FLATBUFFERS\_TEST\_LOCALE="{}"{}\ ./scalar\_parser}
\DoxyCodeLine{>FLATBUFFERS\_TEST\_LOCALE="{}ru\_RU.CP1251"{}\ ./parser\_fuzzer}

\end{DoxyCode}


\doxysection*{Run fuzzer}

These are examples of running a fuzzer. Flags may vary and depend on a version of the lib\+Fuzzer library. For details, run a fuzzer with {\ttfamily -\/help} flag\+: {\ttfamily ./parser\+\_\+fuzzer -\/help=1}

{\ttfamily ./verifier\+\_\+fuzzer ../.corpus\+\_\+verifier/ ../.seed\+\_\+verifier/}

{\ttfamily ./parser\+\_\+fuzzer -\/only\+\_\+ascii=1 -\/max\+\_\+len=500 -\/dict=../parser\+\_\+fbs.dict ../.corpus\+\_\+parser/ ../.seed\+\_\+parser/}

{\ttfamily ./monster\+\_\+fuzzer -\/only\+\_\+ascii=1 -\/max\+\_\+len=500 -\/dict=../monster\+\_\+json.dict ../.corpus\+\_\+monster/ ../.seed\+\_\+monster/}

{\ttfamily ./scalar\+\_\+fuzzer -\/use\+\_\+value\+\_\+profile=1 -\/max\+\_\+len=500 -\/dict=../scalar\+\_\+json.dict ../.corpus\+\_\+scalar/ ../.seed\+\_\+scalar/}

Flag {\ttfamily -\/only\+\_\+ascii=1} is useful for fast number-\/compatibility checking while run {\ttfamily scalar\+\_\+fuzzer}.

Run with a specific C-\/locale\+: {\ttfamily FLATBUFFERS\+\_\+\+TEST\+\_\+\+LOCALE="{}ru\+\_\+\+RU.\+CP1251"{} ./scalar\+\_\+fuzzer -\/reduce\+\_\+depth=1 -\/use\+\_\+value\+\_\+profile=1 -\/shrink=1 -\/max\+\_\+len=3000 -\/timeout=10 -\/rss\+\_\+limit\+\_\+mb=2048 ../.corpus\+\_\+parser/ ../.seed\+\_\+parser/}

\doxysection*{Merge (minimize) corpus}

The {\bfseries{lib\+Fuzzer}} allow to filter (minimize) corpus with help of {\ttfamily -\/merge} flag\+: \begin{quote}
-\/merge If set to 1, any corpus inputs from the 2nd, 3rd etc. corpus directories that trigger new code coverage will be merged into the first corpus directory. Defaults to 0. This flag can be used to minimize a corpus. \end{quote}
Merge several corpuses to a seed directory (a new collected corpus to the seed collection, for example)\+: {\ttfamily ./verifier\+\_\+fuzzer -\/merge=1 ../.seed\+\_\+verifier/ ../.corpus\+\_\+verifier/} {\ttfamily ./parser\+\_\+fuzzer -\/merge=1 ../.seed\+\_\+parser/ ../.corpus\+\_\+parser/} {\ttfamily ./monster\+\_\+fuzzer -\/merge=1 ../.seed\+\_\+monster/ ../.corpus\+\_\+monster/} {\ttfamily ./scalar\+\_\+fuzzer -\/merge=1 ../.seed\+\_\+scalar/ ../.corpus\+\_\+scalar/}

\doxysection*{Know limitations}


\begin{DoxyItemize}
\item LLVM 7.\+0 std\+::regex library has problem with stack overflow, maximum length of input for {\ttfamily scalar\+\_\+fuzzer} run should be limited to 3000. Example\+: {\ttfamily ./scalar\+\_\+fuzzer -\/max\+\_\+len=3000}
\end{DoxyItemize}

\doxysection*{Fuzzing control}

\doxysubsection*{Set timeout or memory limit}

{\ttfamily -\/timeout=10 -\/rss\+\_\+limit\+\_\+mb=2048 -\/jobs=4 -\/workers=4}.

\doxysubsection*{Force stop on first UBSAN error}


\begin{DoxyItemize}
\item {\ttfamily export UBSAN\+\_\+\+OPTIONS=halt\+\_\+on\+\_\+error=1}
\item {\ttfamily export ASAN\+\_\+\+OPTIONS=halt\+\_\+on\+\_\+error=1} 
\end{DoxyItemize}