\chapter{Annotating Flat\+Buffers}
\hypertarget{md_flatbuffers_2docs_2source_2annotation}{}\label{md_flatbuffers_2docs_2source_2annotation}\index{Annotating FlatBuffers@{Annotating FlatBuffers}}
This provides a way to annotate flatbuffer binary data, byte-\/by-\/byte, with a schema. It is useful for development purposes and understanding the details of the internal format.

\doxysection*{Annotating}

Given a {\ttfamily schema}, as either a plain-\/text ({\ttfamily .fbs}) or a binary schema ({\ttfamily .bfbs}), and {\ttfamily binary} file(s) that were created by the {\ttfamily schema}. You can annotate them using\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{flatc\ -\/-\/annotate\ SCHEMA\ -\/-\/\ BINARY\_FILES...}

\end{DoxyCode}


This will produce a set of annotated files ({\ttfamily .afb} Annotated Flat\+Buffer) corresponding to the input binary files.

\doxysubsection*{Example}

Taken from the \href{https://github.com/google/flatbuffers/tree/master/tests/annotated_binary}{\texttt{ tests/annotated\+\_\+binary}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{cd\ tests/annotated\_binary}
\DoxyCodeLine{../../flatc\ -\/-\/annotate\ annotated\_binary.fbs\ -\/-\/\ annotated\_binary.bin}

\end{DoxyCode}


Which will produce a {\ttfamily annotated\+\_\+binary.\+afb} file in the current directory.

!!! Tip \begin{DoxyVerb}The `annotated_binary.bin` is the flatbufer binary of the data contained
within `annotated_binary.json`, which was made by the following command:

```sh
..\..\flatc -b annotated_binary.fbs annotated_binary.json
```
\end{DoxyVerb}
 \doxysection*{.afb Text Format}

Currently there is a built-\/in text-\/based format for outputting the annotations. A full example is shown here\+: \href{https://github.com/google/flatbuffers/blob/master/tests/annotated_binary/annotated_binary.afb}{\texttt{ {\ttfamily annotated\+\_\+binary.\+afb}}}

The data is organized as a table with fixed columns grouped into Binary sections and regions, starting from the beginning of the binary (offset {\ttfamily 0}).

\doxysubsection*{Columns}

The columns are as follows\+:


\begin{DoxyEnumerate}
\item The offset from the start of the binary, expressed in hexadecimal format (e.\+g. {\ttfamily +0x003c}).

The prefix {\ttfamily +} is added to make searching for the offset (compared to some random value) a bit easier.
\item The raw binary data, expressed in hexadecimal format.

This is in the little endian format the buffer uses internally and what you would see with a normal binary text viewer.
\item The type of the data.

This may be the type specified in the schema or some internally defined types\+:
\end{DoxyEnumerate}

\begin{DoxyVerb}| Internal Type | Purpose                                            |
|---------------|----------------------------------------------------|
| `VOffset16`   | Virtual table offset, relative to the table offset |
| `UOffset32`   | Unsigned offset, relative to the current offset    |
| `SOffset32`   | Signed offset, relative to the current offset      |
\end{DoxyVerb}



\begin{DoxyEnumerate}
\item The value of the data.

This is shown in big endian format that is generally written for humans to consume (e.\+g. {\ttfamily 0x0013}). As well as the "{}casted"{} value (e.\+g. {\ttfamily 0x0013}is {\ttfamily 19} in decimal) in parentheses.
\item Notes about the particular data.

This describes what the data is about, either some internal usage, or tied to the schema.
\end{DoxyEnumerate}

\doxysubsection*{Binary Sections}

The file is broken up into Binary Sections, which are comprised of contiguous binary regions that are logically grouped together. For example, a binary section may be a single instance of a flatbuffer {\ttfamily Table} or its {\ttfamily vtable}. The sections may be labelled with the name of the associated type, as defined in the input schema.

An example of a {\ttfamily vtable} Binary Section that is associated with the user-\/defined {\ttfamily Annotate\+Binary.\+Bar} table.


\begin{DoxyCode}{0}
\DoxyCodeLine{vtable\ (AnnotatedBinary.Bar):}
\DoxyCodeLine{\ \ +0x00A0\ |\ 08\ 00\ \ \ \ \ \ |\ uint16\_t\ \ \ |\ 0x0008\ (8)\ \ \ |\ size\ of\ this\ vtable}
\DoxyCodeLine{\ \ +0x00A2\ |\ 13\ 00\ \ \ \ \ \ |\ uint16\_t\ \ \ |\ 0x0013\ (19)\ \ |\ size\ of\ referring\ table}
\DoxyCodeLine{\ \ +0x00A4\ |\ 08\ 00\ \ \ \ \ \ |\ VOffset16\ \ |\ 0x0008\ (8)\ \ \ |\ offset\ to\ field\ \`{}a`\ (id:\ 0)}
\DoxyCodeLine{\ \ +0x00A6\ |\ 04\ 00\ \ \ \ \ \ |\ VOffset16\ \ |\ 0x0004\ (4)\ \ \ |\ offset\ to\ field\ \`{}b`\ (id:\ 1)}

\end{DoxyCode}


These are purely annotative, there is no embedded information about these regions in the flatbuffer itself.

\doxysubsection*{Binary Regions}

Binary regions are contiguous bytes regions that are grouped together to form some sort of value, e.\+g. a {\ttfamily scalar} or an array of scalars. A binary region may be split up over multiple text lines, if the size of the region is large.

\doxysubsubsection*{Annotation Example}

Looking at an example binary region\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{vtable\ (AnnotatedBinary.Bar):}
\DoxyCodeLine{\ \ +0x00A0\ |\ 08\ 00\ \ \ \ \ \ |\ uint16\_t\ \ \ |\ 0x0008\ (8)\ \ \ |\ size\ of\ this\ vtable}

\end{DoxyCode}


The first column ({\ttfamily +0x00\+A0}) is the offset to this region from the beginning of the buffer.

The second column are the raw bytes (hexadecimal) that make up this region. These are expressed in the little-\/endian format that flatbuffers uses for the wire format.

The third column is the type to interpret the bytes as. For the above example, the type is {\ttfamily uint16\+\_\+t} which is a 16-\/bit unsigned integer type.

The fourth column shows the raw bytes as a compacted, big-\/endian value. The raw bytes are duplicated in this fashion since it is more intuitive to read the data in the big-\/endian format (e.\+g., {\ttfamily 0x0008}). This value is followed by the decimal representation of the value (e.\+g., {\ttfamily (8)}). For strings, the raw string value is shown instead.

The fifth column is a textual comment on what the value is. As much metadata as known is provided.

\doxysubsection*{Offsets}

If the type in the 3rd column is of an absolute offset ({\ttfamily SOffet32} or {\ttfamily Offset32}), the fourth column also shows an {\ttfamily Loc\+: +0x025A} value which shows where in the binary this region is pointing to. These values are absolute from the beginning of the file, their calculation from the raw value in the 4th column depends on the context. 