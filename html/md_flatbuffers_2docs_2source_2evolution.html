<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Demo Project: Evolution</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Demo Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Evolution</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>FlatBuffers enables the <a class="el" href="md_flatbuffers_2docs_2source_2schema.html">schema</a> to evolve over time while still maintaining forwards and backwards compatibility with old flatbuffers.</p>
<p>Some rules must be followed to ensure the evolution of a schema is valid.</p>
<h1>Rules</h1>
<p>Adding new tables, vectors, structs to the schema is always allowed. Its only when you add a new field to a <a href="schema.md#tables"><code>table</code></a> that certain rules must be followed.</p>
<h2>Addition</h2>
<p><b>New fields MUST be added to the end of the table definition.</b></p>
<p>This allows older data to still be read correctly (giving you the default value of the added field if accessed).</p>
<p>Older code will simply ignore the new field in the flatbuffer.</p>
<p>!!! tip "Use `id` attributes" </p><pre class="fragment"> You can ignore this rule if you use the `id` attribute on all the fields of a table. This
</pre> <h2>Removal</h2>
<p><b>You MUST not remove a field from the schema, even if you don't use it anymore.</b> You simply stop writing them to the buffer.</p>
<p>Its encouraged to mark the field deprecated by adding the <code>deprecated</code> attribute. This will skip the generation of accessors and setters in the code, to enforce the field not to be used any more.</p>
<h2>Name Changes</h2>
<p>Its generally OK to change the name of tables and fields, as these are not serialized to the buffer. It may break code that would have to be refactored with the updated name.</p>
<h1>Examples</h1>
<p>The following examples uses a base schema and attempts to evolve it a few times. The versions are tracked by <code>V1</code>, <code>V2</code>, etc.. and <code>CodeV1</code> means code compiled against the <code>V1</code> schema.</p>
<h2>Table <a class="el" href="namespaceEvolution.html">Evolution</a></h2>
<p>Lets start with a simple table <code>T</code> with two fields.</p>
<div class="fragment"><div class="line"> ++ title=<span class="stringliteral">&quot;Schema V1&quot;</span></div>
<div class="line">table T {</div>
<div class="line">  a:int;</div>
<div class="line">  b:int;</div>
<div class="line">}</div>
</div><!-- fragment --><p>=== "Well Evolved" </p><pre class="fragment">First lets extend the table with a new field.

```c++ title="Schema V2"
table T {
  a:int;
  b:int;
  c:int;
}
```

This is OK. `CodeV1` reading `V2` data will simply ignore the presence of the
new field `c`. `CodeV2` reading `V1` data will get a default value (0) when
reading `c`.

```c++ title="Schema V3"
table T {
  a:int (deprecated);
  b:int;
  c:int;
}
```

This is OK, removing field `a` via deprecation. `CodeV1`, `CodeV2` and `CodeV3`
reading `V3` data will now always get the default value of `a`, since it is not
present. `CodeV3` cannot write `a` anymore. `CodeV3` reading old data (`V1` or
`V2`) will not be able to access the field anymore, since no generated accessors
are omitted.
</pre><p> === "Improper Addition" </p><pre class="fragment">Add a new field, but this time at the beginning.

```c++ title="Schema V2"
table T {
  c:int;
  a:int;
  b:int;
}
```

This is NOT OK, as it makes `V2` incompatible. `CodeV1` reading `V2` data
will access `a` but will read `c` data.

`CodeV2` reading `V1` data will access `c` but will read `a` data.
</pre><p> === "Improper Deletion" </p><pre class="fragment">Remove a field from the schema.

```c++ title="Schema V2"
table T {
  b:int;
}
```

This is NOT OK. `CodeV1` reading `V2` data will access `a` but read `b` data.

`CodeV2` reading `V1` data will access `b` but will read `a` data.
</pre><p> === "Proper Reordering" </p><pre class="fragment">Lets add a new field to the beginning, but use `id` attributes.

```c++ title="Schema V2"
table T {
  c:int (id: 2);
  a:int (id: 0);
  b:int (id: 1);
}
```

This is OK. This adds the a new field in the beginning, but because all the
`id` attributes were added, it is OK.
</pre><p> === "Changing Types" </p><pre class="fragment">Let change the types of the fields.

```c++ title="Schema V2"
table T {
  a:uint;
  b:uint;
}
```

This is MAYBE OK, and only in the case where the type change is the same
width. This is tricky if the `V1` data contained any negative numbers. So
this should be done with care.
</pre><p> === "Changing Defaults" </p><pre class="fragment">Lets change the default values of the existing fields.

```c++ title="Schema V2"
table T {
  a:int = 1;
  b:int = 2;
}
```

This is NOT OK. Any `V1` data that did not have a value written to the
buffer relied on generated code to provide the default value.

There MAY be cases where this is OK, if you control all the producers and
consumers, and you can update them in tandem.
</pre><p> === "Renaming Fields" </p><pre class="fragment">Lets change the name of the fields

```c++ title="Schema V2"
table T {
  aa:int;
  bb:int;
}
```

This is generally OK. You've renamed fields will break all code and JSON
files that use this schema, but you can refactor those without affecting the
binary data, since the binary only address fields by id and offset, not by
names.
</pre> <h2>Union <a class="el" href="namespaceEvolution.html">Evolution</a></h2>
<p>Lets start with a simple union <code>U</code> with two members.</p>
<div class="fragment"><div class="line"> ++ title=<span class="stringliteral">&quot;Schema V1&quot;</span></div>
<div class="line"><span class="keyword">union </span>U {</div>
<div class="line">  A,</div>
<div class="line">  B</div>
<div class="line">}</div>
</div><!-- fragment --><p>=== "Well Evolved" </p><pre class="fragment">Lets add a another variant to the end.

```c++ title="Schema V2"
union U {
  A,
  B,
  another_a: A
}
```

This is OK. `CodeV1` will not recognize the `another_a`.
</pre><p> === "Improper Evolved" </p><pre class="fragment">Lets add a another variant to the middle.

```c++ title="Schema V2"
union U {
  A,
  another_a: A,
  B
}
```

This is NOT OK. `CodeV1` reading `V2` data will interpret `B` as `another_a`.
`CodeV2` reading `V1` data will interpret `another_a` as `B`.
</pre><p> === "Evolved With Discriminant" </p><pre class="fragment">Lets add a another variant to the middle, this time adding a union "discriminant".

```c++ title="Schema V2"
union U {
  A = 1,
  another_a: A = 3,
  B = 2
}
```

This is OK. Its like you added it to the end, but using the discriminant
value to physically place it elsewhere in the union.
</pre> <h1>Version Control</h1>
<p>FlatBuffers relies on new field declarations being added at the end, and earlier declarations to not be removed, but be marked deprecated when needed. We think this is an improvement over the manual number assignment that happens in Protocol Buffers (and which is still an option using the <code>id</code> attribute mentioned above).</p>
<p>One place where this is possibly problematic however is source control. If user <code>A</code> adds a field, generates new binary data with this new schema, then tries to commit both to source control after user <code>B</code> already committed a new field also, and just auto-merges the schema, the binary files are now invalid compared to the new schema.</p>
<p>The solution of course is that you should not be generating binary data before your schema changes have been committed, ensuring consistency with the rest of the world. If this is not practical for you, use explicit field <code>id</code>s, which should always generate a merge conflict if two people try to allocate the same id. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
