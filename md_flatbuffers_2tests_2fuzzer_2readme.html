<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Demo Project: Test Flatbuffers library with help of libFuzzer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Demo Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Test Flatbuffers library with help of libFuzzer</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Test suite of Flatbuffers library has fuzzer section with tests are based on libFuzzer library.</p>
<blockquote class="doxtable">
<p>&zwj;LibFuzzer is in-process, coverage-guided, evolutionary fuzzing engine. </p>
</blockquote>
<p>LibFuzzer is linked with the library under test, and feeds fuzzed inputs to the library via a specific fuzzing entrypoint (aka “target function”); the fuzzer then tracks which areas of the code are reached, and generates mutations on the corpus of input data in order to maximize the code coverage. The code coverage information for libFuzzer is provided by LLVM’s SanitizerCoverage instrumentation.</p>
<p>For details about <b>libFuzzer</b> see: <a href="https://llvm.org/docs/LibFuzzer.html">https://llvm.org/docs/LibFuzzer.html</a></p>
<p>To build and run these tests LLVM compiler (with clang frontend) and CMake should be installed before.</p>
<p>The fuzzer section include four tests:</p><ul>
<li><code>annotator_fuzzer</code> checks that inputs given to the flatc &ndash;annotate are always parsable;</li>
<li><code>verifier_fuzzer</code> checks stability of deserialization engine for <code>Monster</code> schema;</li>
<li><code>parser_fuzzer</code> checks stability of schema and json parser under various inputs;</li>
<li><code>scalar_parser</code> focused on validation of the parser while parse numeric scalars in schema and/or json files;</li>
<li><code>flexverifier_fuzzer</code> checks stability of deserialization engine for FlexBuffers only;</li>
</ul>
<h1>Build</h1>
<div class="fragment"><div class="line">cd tests/fuzzer</div>
<div class="line">CC=clang CXX=clang++ cmake . -DCMAKE_BUILD_TYPE=Debug -DUSE_ASAN=ON</div>
</div><!-- fragment --><h1>Run tests with a specific locale</h1>
<p>The grammar of the Flatbuffers library is based on printable-ASCII characters. By design, the Flatbuffers library should be independent of the global or thread locales used by an end-user application. Set environment variable <code>FLATBUFFERS_TEST_LOCALE</code> to run a fuzzer with a specific C-locale: </p><div class="fragment"><div class="line">&gt;FLATBUFFERS_TEST_LOCALE=&quot;&quot; ./scalar_parser</div>
<div class="line">&gt;FLATBUFFERS_TEST_LOCALE=&quot;ru_RU.CP1251&quot; ./parser_fuzzer</div>
</div><!-- fragment --><h1>Run fuzzer</h1>
<p>These are examples of running a fuzzer. Flags may vary and depend on a version of the libFuzzer library. For details, run a fuzzer with <code>-help</code> flag: <code>./parser_fuzzer -help=1</code></p>
<p><code>./verifier_fuzzer ../.corpus_verifier/ ../.seed_verifier/</code></p>
<p><code>./parser_fuzzer -only_ascii=1 -max_len=500 -dict=../parser_fbs.dict ../.corpus_parser/ ../.seed_parser/</code></p>
<p><code>./monster_fuzzer -only_ascii=1 -max_len=500 -dict=../monster_json.dict ../.corpus_monster/ ../.seed_monster/</code></p>
<p><code>./scalar_fuzzer -use_value_profile=1 -max_len=500 -dict=../scalar_json.dict ../.corpus_scalar/ ../.seed_scalar/</code></p>
<p>Flag <code>-only_ascii=1</code> is useful for fast number-compatibility checking while run <code>scalar_fuzzer</code>.</p>
<p>Run with a specific C-locale: <code>FLATBUFFERS_TEST_LOCALE="ru_RU.CP1251" ./scalar_fuzzer -reduce_depth=1 -use_value_profile=1 -shrink=1 -max_len=3000 -timeout=10 -rss_limit_mb=2048 ../.corpus_parser/ ../.seed_parser/</code></p>
<h1>Merge (minimize) corpus</h1>
<p>The <b>libFuzzer</b> allow to filter (minimize) corpus with help of <code>-merge</code> flag: </p><blockquote class="doxtable">
<p>&zwj;-merge If set to 1, any corpus inputs from the 2nd, 3rd etc. corpus directories that trigger new code coverage will be merged into the first corpus directory. Defaults to 0. This flag can be used to minimize a corpus. </p>
</blockquote>
<p>Merge several corpuses to a seed directory (a new collected corpus to the seed collection, for example): <code>./verifier_fuzzer -merge=1 ../.seed_verifier/ ../.corpus_verifier/</code> <code>./parser_fuzzer -merge=1 ../.seed_parser/ ../.corpus_parser/</code> <code>./monster_fuzzer -merge=1 ../.seed_monster/ ../.corpus_monster/</code> <code>./scalar_fuzzer -merge=1 ../.seed_scalar/ ../.corpus_scalar/</code></p>
<h1>Know limitations</h1>
<ul>
<li>LLVM 7.0 std::regex library has problem with stack overflow, maximum length of input for <code>scalar_fuzzer</code> run should be limited to 3000. Example: <code>./scalar_fuzzer -max_len=3000</code></li>
</ul>
<h1>Fuzzing control</h1>
<h2>Set timeout or memory limit</h2>
<p><code>-timeout=10 -rss_limit_mb=2048 -jobs=4 -workers=4</code>.</p>
<h2>Force stop on first UBSAN error</h2>
<ul>
<li><code>export UBSAN_OPTIONS=halt_on_error=1</code></li>
<li><code>export ASAN_OPTIONS=halt_on_error=1</code> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
